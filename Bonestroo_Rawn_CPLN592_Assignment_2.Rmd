---
title: "CPLN 592 Assignment 2"
author: "Hannah Bonestroo and Brian Rawn"
date: "10/16/2020"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
<style>

table, td, th {
  border: none;
  padding-left: 1em;
  padding-right: 1em;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1em;
  margin-bottom: 1em;
}

</style>

# Hedonic Home Price Prediction in Miami, Florida

***
# 1.1 Introduction
Write about intro

# 1.2 Data 
## Features

```{r setup, results='hide', error=FALSE, message=FALSE, warning=FALSE}
setwd("C:/Users/Hannah/Documents/Penn/Fall 2020/CPLN-592/Assignments/Assignment 2/CPLN592Assignment2")
library(tidyverse)
library(tidycensus)
library(kableExtra)
library(tidycensus)
library(sf)
library(gridExtra)
library(grid)
library(knitr)
library(rmarkdown)
library(ggcorrplot)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(rgdal)
library(raster)
library(rgeos)
library(sp)
library(tidyr)
library(dplyr)
library(osmdata)
library(mapview)
library(RANN)
library(ggplot2)
library(stargazer)
library(table1)
library(summarytools)
library(arsenal)
library(expss)
options(scipen=999)
options(tigris_class = "sf")

#Load Styles
mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}
# Load Quantile break functions
qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

q5 <- function(variable) {as.factor(ntile(variable, 5))}

# Load hexadecimal color palette
palette5 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")

# Load nn function
nn_function <- function(measureFrom,measureTo,k) { 
  measureFrom_Matrix <- as.matrix(measureFrom)
  measureTo_Matrix <- as.matrix(measureTo)
  nn <-   
    get.knnx(measureTo, measureFrom, k)$nn.dist
  output <-
    as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>% 
    dplyr::select(-thisPoint) %>%
    pull()}
  
# Load census API key
census_api_key("91a259a2aaac3093a636d189040e0ff263fc823b", overwrite = TRUE)

# Load Assignment 2 student data
Miami_Houses <- 
  rbind(
    st_read("studentsData.geojson") %>%
    st_transform(st_crs('EPSG:6346')))
Miami_Houses <- st_set_crs(Miami_Houses, 6346)
Miami_Houses <- distinct(Miami_Houses,  .keep_all = TRUE)
```

The METRO Green Line consists of fourteen stops in St. Paul and extends from downtown onward into Minneapolis. 
```{r Loading Variables, results='hide', error=FALSE, message=FALSE, warning=FALSE}
# Load neighborhood boundaries

nhoodsmiami <- 
  rbind(
  st_read("https://opendata.arcgis.com/datasets/2f54a0cbd67046f2bd100fb735176e6c_0.geojson") %>%
  st_transform('EPSG:6346'))
nhoodsmiami <- st_set_crs(nhoodsmiami, 6346)

nhoodsmiamibeach <-
  rbind(st_read("neighborhoods/miamineighborhoods.shp")%>%
  st_transform('EPSG:6346'))
nhoodsmiamibeach <- st_set_crs(nhoodsmiamibeach,6346)

nhoodsmiami <- nhoodsmiami[2]
nhoodsmiamibeach <-nhoodsmiamibeach[1]%>%
 rename(LABEL = Name)
nhoodsmiami <-st_zm(nhoodsmiami, drop = TRUE, what = "ZM")
nhoodsmiamibeach <-st_zm(nhoodsmiamibeach, drop=TRUE, what = "ZM")
nhoods <- rbind(nhoodsmiami,nhoodsmiamibeach)%>%
  rename(neighborhood = LABEL)


# Create column with neighborhoods name

Miami_Houses <- st_join(Miami_Houses, nhoods, join = st_within)

# fix limited data nhoods

Miami_Houses$neighborhood2 <- ifelse(grepl("East Grove", Miami_Houses$neighborhood),Miami_Houses$neighborhood2<-"North Grove",
                                     ifelse(grepl("Bird Grove West", Miami_Houses$neighborhood), Miami_Houses$neighborhood2<-"Bird Grove East",
                                            ifelse(grepl("Bay Heights", Miami_Houses$neighborhood), Miami_Houses$neighborhood2<-"North Grove",
                                                  ifelse(grepl("Vizcaya", Miami_Houses$neighborhood), Miami_Houses$neighborhood2<-"North Grove",
                                                   ifelse(grepl("Fair Isle", Miami_Houses$neighborhood), Miami_Houses$neighborhood2<-"North Grove",Miami_Houses$neighborhood2<-Miami_Houses$neighborhood)))))

# Load demographic data from ACS

tracts18 <- 
  get_acs(geography = "tract", variables = c("B25026_001E","B02001_002E","B15001_050E",
                                             "B15001_009E","B19013_001E","B25058_001E",
                                             "B06012_002E"), 
          year=2018, state=12, county="Miami-Dade County", geometry=T, output="wide") %>%
  st_transform('EPSG:6346')%>%
  rename(TotalPop = B25026_001E, 
         Whites = B02001_002E,
         FemaleBachelors = B15001_050E, 
         MaleBachelors = B15001_009E,
         MedHHInc = B19013_001E, 
         MedRent = B25058_001E,
         TotalPoverty = B06012_002E) %>%
  dplyr::select(-NAME, -starts_with("B")) %>%
  mutate(pctWhite = ifelse(TotalPop > 0, Whites / TotalPop, 0),
         pctBachelors = ifelse(TotalPop > 0, ((FemaleBachelors + MaleBachelors) / TotalPop), 0),
         pctPoverty = ifelse(TotalPop > 0, TotalPoverty / TotalPop, 0),
         year = "2018") %>%
  dplyr::select(-Whites, -TotalPoverty) 

# select only tracts in Miami/Miami Beach

miami <- st_union(nhoods)
tracts.miami.intersect <- st_intersects(miami, tracts18)
tracts18miami <- tracts18[tracts.miami.intersect[[1]],]

# create columns with Census variables

Miami_Houses <- st_join(Miami_Houses,tracts18miami, join=st_within)

# Load Crime point data

miamicrime <- 
  rbind(
    st_read("MiamiCrime/09-27-10-03-2020-miamicrime.shp") %>% 
      st_transform(st_crs('EPSG:6346')))

# Create columns for nearest neighbor crime

st_c <- st_coordinates

Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    crime_nn2 = nn_function(st_c(st_centroid(Miami_Houses)),
      st_c(st_centroid(miamicrime)), 2)) 
 

# create columns for house attributes

Miami_Houses$Pool <- ifelse(grepl("Pool", Miami_Houses$XF1), Miami_Houses$Pool<-"yes",
                            ifelse(grepl("Pool", Miami_Houses$XF2), Miami_Houses$Pool<-"yes",
                                          ifelse(grepl("Pool", Miami_Houses$XF3), Miami_Houses$Pool<-"yes",Miami_Houses$Pool<-"no")))

Miami_Houses$Patio <- ifelse(grepl("Patio", Miami_Houses$XF1), Miami_Houses$Patio<-"yes",
                            ifelse(grepl("Patio", Miami_Houses$XF2), Miami_Houses$Patio<-"yes",
                                   ifelse(grepl("Patio", Miami_Houses$XF3), Miami_Houses$Patio<-"yes",Miami_Houses$Patio<-"no")))

Miami_Houses$Carport <- ifelse(grepl("Carport", Miami_Houses$XF1), Miami_Houses$Carport<-"yes",
                            ifelse(grepl("Carport", Miami_Houses$XF2), Miami_Houses$Carport<-"yes",
                                   ifelse(grepl("Carport", Miami_Houses$XF3), Miami_Houses$Carport<-"yes",Miami_Houses$Carport<-"no")))

Miami_Houses$Whirlpool <- ifelse(grepl("Whirlpool", Miami_Houses$XF1), Miami_Houses$Whirlpool<-"yes",
                            ifelse(grepl("Whirlpool", Miami_Houses$XF2), Miami_Houses$Whirlpool<-"yes",
                                   ifelse(grepl("Whirlpool", Miami_Houses$XF3), Miami_Houses$Whirlpool<-"yes",Miami_Houses$Whirlpool<-"no")))

Miami_Houses$Dock <- ifelse(grepl("Dock", Miami_Houses$XF1), Miami_Houses$Dock<-"yes",
                            ifelse(grepl("Dock", Miami_Houses$XF2), Miami_Houses$Dock<-"yes",
                                   ifelse(grepl("Dock", Miami_Houses$XF3), Miami_Houses$Dock<-"yes",Miami_Houses$Dock<-"no")))

# load beach feature

miamibeach <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/d0d6e6c9d47145a0b05d6621ef29d731_0.geojson") %>%
      st_transform('EPSG:6346'))
miamibeach <- st_set_crs(miamibeach, 6346)

# add column for distance to beach

miamibeach <- st_union(miamibeach)
Miami_Houses.centroids <-st_centroid(Miami_Houses)
Miami_Houses$beachDist <-st_distance(Miami_Houses.centroids, miamibeach)
Miami_Houses$beachDist <-as.numeric(Miami_Houses$beachDist)

# load water feature

miamiwater <-
  rbind(st_read("Water/miamiwater.shp")%>%
          st_transform('EPSG:6346'))
miamiwater <- st_set_crs(miamiwater,6346)

# add column for distance to water

miamiwater <- st_union(miamiwater)
Miami_Houses$waterDist <-st_distance(Miami_Houses.centroids, miamiwater)
Miami_Houses$waterDist <-as.numeric(Miami_Houses$waterDist)


# add parks feature

miami_municipalparks <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/a585b193a4764760802f510f8c5b1452_0.geojson") %>%
      st_transform('EPSG:6346'))
miami_municipalparks <- st_set_crs(miami_municipalparks, 6346)

#add column for distance to park

miami_municipalparks <- st_union(miami_municipalparks)
Miami_Houses$ParksDist <-st_distance(Miami_Houses.centroids,miami_municipalparks)
Miami_Houses$ParksDist <-as.numeric(Miami_Houses$ParksDist)


# load Starbucks points

Starbucks <- st_read("Starbucks.csv")
Starbucks.sf <- st_as_sf(Starbucks, coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>% 
  st_transform(st_crs(Miami_Houses))

st_c <- st_coordinates

# add column for nearest neighbor Starbucks
Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    Starbucks_nn1 = nn_function(st_c(st_centroid(Miami_Houses)), st_c(st_centroid(Starbucks.sf)), 1))

# load golf course feature

miamigolfcourses <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/229eeac512b043f8bf5317ec8377f151_0.geojson") %>%
      st_transform('EPSG:6346'))
miamigolfcourses <- st_set_crs(miamigolfcourses, 6346)

# add column for distance to golf course

miamigolfcourses <- st_union(miamigolfcourses)
Miami_Houses$GolfCourseDist<-st_distance(Miami_Houses.centroids,miamigolfcourses)
Miami_Houses$GolfCourseDist <-as.numeric(Miami_Houses$GolfCourseDist)

# load metro stations

miami_metros <- st_read("MetroRailStations/Metrorail_Station.csv")
miami_metros.sf <- st_as_sf(miami_metros, coords = c("LON","LAT"), crs = 4326, agr = "constant") %>% 
  st_transform(st_crs(Miami_Houses))
miami_metros.sf <- st_set_crs(miami_metros.sf, 6346)
                               
st_c <- st_coordinates

Miami_Houses.centroids <-st_centroid(miami_metros.sf)

# add column for distance to metro 

Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    Metros_nn1 = nn_function(st_c(st_centroid(Miami_Houses)), st_c(st_centroid(miami_metros.sf)), 1))

# load miami highways

miamiHighways <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/6d31141fd24148f0b352f341ef38d161_0.geojson") %>%
      st_transform('EPSG:6346'))
miamiHighways <- st_set_crs(miamiHighways,6346)

miamiHighwaysbuffer.125 <- 
  rbind(
    st_union(st_buffer(miamiHighways, 201.168)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))
miamiHighwaysbuffer.125<-miamiHighwaysbuffer.125%>%
  rename(buffer.125 = Legend)
miamiHighwaysbuffer.25 <- 
  rbind(
    st_union(st_buffer(miamiHighways, 402.336)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))
miamiHighwaysbuffer.25<-miamiHighwaysbuffer.25%>%
  rename(buffer.25 = Legend)
miamiHighwaysbuffer.5 <- 
  rbind(
    st_union(st_buffer(miamiHighways, 804.672)) %>%
      st_sf() %>%
      mutate(Legend = "Unioned Buffer"))
miamiHighwaysbuffer.5<-miamiHighwaysbuffer.5%>%
  rename(buffer.5 = Legend)

Miami_Houses <- st_join(Miami_Houses, miamiHighwaysbuffer.125, join = st_within)
Miami_Houses <- st_join(Miami_Houses, miamiHighwaysbuffer.25, join = st_within)
Miami_Houses <- st_join(Miami_Houses, miamiHighwaysbuffer.5, join = st_within)

# add column for distance to highway

Miami_Houses$Highwaydist <- ifelse(grepl("Unioned Buffer", Miami_Houses$buffer.125), Miami_Houses$Highwaydist<-".125",
                            ifelse(grepl("Unioned Buffer", Miami_Houses$buffer.25), Miami_Houses$Highwaydist<-".25",
                                   ifelse(grepl("Unioned Buffer", Miami_Houses$buffer.5), Miami_Houses$Highwaydist<-".5",Miami_Houses$Highwaydist<-"over .5")))


# load middle school districts

miami.middleschools <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/dd2719ff6105463187197165a9c8dd5c_0.geojson") %>%
      st_transform('EPSG:6346'))
miami.middleschools <- st_set_crs(miami.middleschools,6346)
miami.middleschools <- miami.middleschools[,3]%>%rename(midschool = NAME)

# add column for middle school district

Miami_Houses <- st_join(Miami_Houses, miami.middleschools, join = st_within)

# load school districts

miami.schooldistricts <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/bc16a5ebcdcd4f3e83b55c5d697a0317_0.geojson") %>%
      st_transform('EPSG:6346'))
miami.schooldistricts <- st_set_crs(miami.schooldistricts,6346)
miami.schooldistricts <- miami.schooldistricts[,2]%>%
  rename(schooldist = ID)

# add column for school districts

Miami_Houses <- st_join(Miami_Houses, miami.schooldistricts, join = st_within)

# load daycares

miami.daycares <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/3ea3c3aa067549ff8f8a8ab80a3cbcbb_0.geojson") %>%
      st_transform('EPSG:6346'))
miami.daycares <- st_set_crs(miami.daycares,6346)
st_c <- st_coordinates

# add columns for nearest neighbor daycares

Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    daycare_nn2 = nn_function(st_c(st_centroid(Miami_Houses)), st_c(st_centroid(miami.daycares)), 2))


# load colleges

miami.colleges <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/7db056c406b943dc8f3f377b99d77588_0.geojson") %>%
      st_transform('EPSG:6346'))
miami.colleges <- st_set_crs(miami.colleges,6346)
st_c <- st_coordinates

# add columns for nearest neighbor colleges

Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    colleges_nn3 = nn_function(st_c(st_centroid(Miami_Houses)), st_c(st_centroid(miami.colleges)), 3))


# load contaminated sites

miami.contamination <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/43750f842b1e451aa0347a2ca34a61d7_0.geojson") %>%
      st_transform('EPSG:6346'))
miami.contamination <- st_set_crs(miami.contamination,6346)
st_c <- st_coordinates

# add columns for contaminated sites nearest neighbor

Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    contamination_nn3 = nn_function(st_c(st_centroid(Miami_Houses)), st_c(st_centroid(miami.contamination)), 3))


#  load private schools

miami.pschool <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/7fecb87ea1b1494eb2beb13906465de9_0.geojson") %>%
      st_transform('EPSG:6346'))
miami.pschool <- st_set_crs(miami.pschool,6346)
st_c <- st_coordinates

# add columns for private schools nearest neighbor

Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    pschool_nn3 = nn_function(st_c(st_centroid(Miami_Houses)), st_c(st_centroid(miami.pschool)), 3))

# load hospitals

miami.hospitals <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/0067a0e8b40644f980afa23ad34c32c4_0.geojson") %>%
      st_transform('EPSG:6346'))
miami.hospitals <- st_set_crs(miami.hospitals,6346)
st_c <- st_coordinates

# add columns for hospital nearest neighbor

Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    hospitals_nn3 = nn_function(st_c(st_centroid(Miami_Houses)), st_c(st_centroid(miami.hospitals)), 3))


#load marinas

miami.marinas <- 
  rbind(
    st_read("https://opendata.arcgis.com/datasets/f65dec3bacb341f094dd5109e93c4247_0.geojson") %>%
      st_transform('EPSG:6346'))
miami.marinas <- st_set_crs(miami.marinas,6346)
st_c <- st_coordinates

# add columns for marinas nearest neighbor

Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    marinas_nn2 = nn_function(st_c(st_centroid(Miami_Houses)), st_c(st_centroid(miami.marinas)), 2))


# Load Open streets map data for bars and restaurants

miami.base <- 
  st_read("https://opendata.arcgis.com/datasets/5ece0745e24b4617a49f2e098df8117f_0.geojson") %>%
  filter(NAME == "MIAMI BEACH" | NAME == "MIAMI") %>%
  st_union()
xmin = st_bbox(miami.base)[[1]]
ymin = st_bbox(miami.base)[[2]]
xmax = st_bbox(miami.base)[[3]]  
ymax = st_bbox(miami.base)[[4]]

ggplot() +
  geom_sf(data=miami.base, fill="black") +
  geom_sf(data=st_as_sfc(st_bbox(miami.base)), colour="red", fill=NA)
bars <- opq(bbox = c(xmin, ymin, xmax, ymax)) %>% 
  add_osm_feature(key = 'amenity', value = c("bar", "pub", "restaurant")) %>%
  osmdata_sf()

bars <- 
  bars$osm_points %>%
  .[miami.base,]

bars <- st_transform(bars,6346)
bars <- st_set_crs(bars,6346)
st_c <- st_coordinates

# add columns for nearest neighbor bars and restaurants

Miami_Houses <-
  Miami_Houses %>% 
  mutate(
    bars_nn2 = nn_function(st_c(st_centroid(Miami_Houses)), st_c(st_centroid(bars)), 2))

# add column for spatial lag of Sq ft

Miami_Houses.centroids<-st_centroid(Miami_Houses)
coords.test <- st_centroid(st_geometry(Miami_Houses), of_largest_polygon=TRUE)
coords <-  st_coordinates(Miami_Houses.centroids)
neighborList <- knn2nb(knearneigh(coords.test, 5))
spatialWeights <- nb2listw(neighborList, style="W")
Miami_Houses$lagSQ <- lag.listw(spatialWeights, Miami_Houses$ActualSqFt)

# add column for spatial lag of Lot Size

Miami_Houses.centroids<-st_centroid(Miami_Houses)
coords.test <- st_centroid(st_geometry(Miami_Houses), of_largest_polygon=TRUE)
coords <-  st_coordinates(Miami_Houses.centroids)
neighborList <- knn2nb(knearneigh(coords.test, 5))
spatialWeights <- nb2listw(neighborList, style="W")
Miami_Houses$lagLot <- lag.listw(spatialWeights, Miami_Houses$LotSize)

# create training data

Miami_Training <- subset(Miami_Houses, toPredict %in% 0)

#create test data

`%nin%` = Negate(`%in%`)
Miami_Test <- subset(Miami_Houses,toPredict %nin% 0)

# finding average sale price of 5 nearest neighbors Test set

Miami_TestPPP <-as.ppp(st_centroid(Miami_Test))
Miami_TrainingPPP<-as.ppp(st_centroid(Miami_Training))

Miami_Test$nnHouse1 <- nncross(Miami_TestPPP, Miami_TrainingPPP, what="which",k=1)
Miami_Test$nnHouse2 <- nncross(Miami_TestPPP, Miami_TrainingPPP, what="which",k=2)
Miami_Test$nnHouse3 <- nncross(Miami_TestPPP, Miami_TrainingPPP, what="which",k=3)
Miami_Test$nnHouse4 <- nncross(Miami_TestPPP, Miami_TrainingPPP, what="which",k=4)
Miami_Test$nnHouse5 <- nncross(Miami_TestPPP, Miami_TrainingPPP, what="which",k=5)
Miami_Training$ID <- 1:1819

price <- function(data) {
  price1<-Miami_Training$SalePrice[Miami_Training$ID==data]
  return(price1)
}

Miami_Test$price1 <- lapply(Miami_Test$nnHouse1,price)
Miami_Test$price2 <- lapply(Miami_Test$nnHouse2,price)
Miami_Test$price3 <- lapply(Miami_Test$nnHouse3,price)
Miami_Test$price4 <- lapply(Miami_Test$nnHouse4,price)
Miami_Test$price5 <- lapply(Miami_Test$nnHouse5,price)

Miami_Test$price1 <- as.numeric(Miami_Test$price1)
Miami_Test$price2 <- as.numeric(Miami_Test$price2)
Miami_Test$price3 <- as.numeric(Miami_Test$price3)
Miami_Test$price4 <- as.numeric(Miami_Test$price4)
Miami_Test$price5 <- as.numeric(Miami_Test$price5)

Miami_Test$SalePriceAvg <- (Miami_Test$price1+Miami_Test$price2+Miami_Test$price3+Miami_Test$price4+Miami_Test$price5)/5

# finding average sale price of 5 nearest neighbors Training Set

Miami_Training$nnHouse1 <- nncross(Miami_TrainingPPP, Miami_TrainingPPP, what="which",k=2)
Miami_Training$nnHouse2 <- nncross(Miami_TrainingPPP, Miami_TrainingPPP, what="which",k=3)
Miami_Training$nnHouse3 <- nncross(Miami_TrainingPPP, Miami_TrainingPPP, what="which",k=4)
Miami_Training$nnHouse4 <- nncross(Miami_TrainingPPP, Miami_TrainingPPP, what="which",k=5)
Miami_Training$nnHouse5 <- nncross(Miami_TrainingPPP, Miami_TrainingPPP, what="which",k=6)

price <- function(data) {
  price1<-Miami_Training$SalePrice[Miami_Training$ID==data]
  return(price1)
}

Miami_Training$price1 <- lapply(Miami_Training$nnHouse1,price)
Miami_Training$price2 <- lapply(Miami_Training$nnHouse2,price)
Miami_Training$price3 <- lapply(Miami_Training$nnHouse3,price)
Miami_Training$price4 <- lapply(Miami_Training$nnHouse4,price)
Miami_Training$price5 <- lapply(Miami_Training$nnHouse5,price)

Miami_Training$price1 <- as.numeric(Miami_Training$price1)
Miami_Training$price2 <- as.numeric(Miami_Training$price2)
Miami_Training$price3 <- as.numeric(Miami_Training$price3)
Miami_Training$price4 <- as.numeric(Miami_Training$price4)
Miami_Training$price5 <- as.numeric(Miami_Training$price5)

Miami_Training$SalePriceAvg <- (Miami_Training$price1+Miami_Training$price2+Miami_Training$price3+Miami_Training$price4+Miami_Training$price5)/5


```


```{r Create Training data, results='hide', error=FALSE, message=FALSE, warning=FALSE,fig.asp=0.5}


#Labels

Miami_Houses = apply_labels(Miami_Houses,
                      ActualSqFt = "Square Feet",
                      YearBuilt = "Year Built",
                      Stories = "Stories",
                      Bath = "Baths",
                      Bed = "Beds",
                      LotSize = "Lot Size",
                      Zoning = "Zoning Category",
                      bars = "Bars(nn2 m)",
                      marinas_nn2 = "Marinas(nn2 m)",
                      pschool_nn3 = "Private Schools(nn3 m)",
                      contamination_nn3= "Contamination Sites(nn3 m)",
                      colleges_nn3 = "Colleges(nn3 m)",
                      daycare_nn2 = "Daycares(nn2 m)",
                      schooldist = "School District",
                      midschool= "Middle School",
                      Highwaydist="Dist to Highway (m)",
                      Metros_nn1 = "Dist to Meto Station (m)",
                      GolfCourseDist = "Dist to Golf Course (m)",
                      Starbucks_nn1 = "Dist to Starbucks (m)",
                      ParksDist ="Dist to Park (m)",
                      waterDist = "Dist to Water (m)",
                      beachDist = "Dist to Beach (m)",
                      crime_nn2 = "Crimes (nn2 m)")


# internal characteristics

Miami_Training_internal<-Miami_Training[,c("Bed","LotSize",
                                          "Bath","YearBuilt","Stories","ActualSqFt",
                                          
                                                     
                                                "Pool",                 
                                          "Patio",                "Carport",               "Whirlpool",            
                                          "Dock")]

# amenities characteristics

Miami_Training_spatial<-Miami_Training[,c("Property.City","Zoning",
                                           
                                      
                                           "crime_nn2",            
                                                    
                                                  "neighborhood" ,                   
                                                 
                                           "contamination_nn3",           
                                                                     
                                           "MedHHInc",            
                                           "MedRent",               "pctWhite",              "pctBachelors",         
                                           "pctPoverty",                                           "lagLot" ,              
                                           "lagSQ")]

# amenities characteristics

Miami_Training_amenities<-Miami_Training[,c(
                                                 
                                           "beachDist",            "waterDist" ,         "GolfCourseDist",        "Metros_nn1",           
                                           "Highwaydist"   ,                "midschool"  ,          
                                           "schooldist" ,          "daycare_nn2"  ,         "colleges_nn3",        
                                           "pschool_nn3",          "hospitals_nn3",        
                                           "marinas_nn2"          )]


```

``````{r feature summary statistics, results='asis',fig.width=24, fig.height=8}
Miami_Training_internal = apply_labels(Miami_Training_internal,
                      ActualSqFt = "Square Feet",
                      YearBuilt = "Year Built",
                      Stories = "Stories",
                      Bath = "Baths",
                      Bed = "Beds",
                      LotSize = "Lot Size",
                      Zoning = "Zoning Category",
                      bars = "Bars(nn2 m)",
                      marinas_nn2 = "Marinas(nn2 m)",
                      pschool_nn3 = "Private Schools(nn3 m)",
                      contamination_nn3= "Contamination Sites(nn3 m)",
                      colleges_nn3 = "Colleges(nn3 m)",
                      daycare_nn2 = "Daycares(nn2 m)",
                      schooldist = "School District",
                      midschool= "Middle School",
                      Highwaydist="Dist to Highway (m)",
                      Metros_nn1 = "Dist to Meto Station (m)",
                      GolfCourseDist = "Dist to Golf Course (m)",
                      Starbucks_nn1 = "Dist to Starbucks (m)",
                      ParksDist ="Dist to Park (m)",
                      waterDist = "Dist to Water (m)",
                      beachDist = "Dist to Beach (m)",
                      crime_nn2 = "Crimes (nn2 m)")
stargazer(
  as.data.frame(Miami_Training_internal[,c("LotSize","YearBuilt","ActualSqFt")]), type = "html",
  summary.stat = c("min", "p25", "median", "p75", "max", "median", "sd"),
  header = FALSE,
  title = "Internal Characteristics Summary Statistics",
  notes = "Table 1.1 ",
                notes.align = "l",
                float = TRUE,
                table.placement = "H")


Yes = {'Yes';'No'};
a<-tableby(~Pool,data = Miami_Training)
labels(a)<- c(Pool='Pool')
b<-table(Miami_Training$Patio)
c<-table(Miami_Training$Dock)

d<-table(Miami_Training$neighborhood)

kable(list(a,b,c),format = "html", caption = "Title of the table") %>% 
  kable_styling() %>%
  footnote(general_title = "\n",
           general = "Table 2.2")
  
kable(d,format = "html", caption = "Title of the table") %>% 
  kable_styling() %>%
  footnote(general_title = "\n",
           general = "Table 2.2")
  

d<-ggplot(data.frame(Miami_Training$Zoning), aes(x=Miami_Training$Zoning)) +
  geom_bar()+
  labs(title = "Frequency of Zoning", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  plotTheme()
plot(d)
```

Variable Name | Feature | Units | Type
------------- | ------------- | -------------| -------------
ActualSqFt| Actual Square Feet | Square Feet | Numerical
Bath|Number of Baths | - | Categorical 
Bed  |Number of Beds | - | Categorical 
Carport | Car Port | - | Categorical 
Dock | Dock | - | Categorical 
LotSize | Lot Size | Square Feet | Numerical
Patio | Patio | - |Categorical 
Pool | Pool | - | Categorical 
Whirlpool | Whirlpool | - | Categorical 

```{r submarket plots2,echo=FALSE, error=FALSE, message=FALSE, warning=FALSE,fig.asp=.5}



```


